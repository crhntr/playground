<head>
    <title>Run</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="go-playground-webapp-location" content="">
    <meta name="go-playground-run-id" content="">

    <script id="run">
        const webappLocation = document.querySelector('head>meta[name="go-playground-webapp-location"]').getAttribute('content')

        async function run(runID, binary) {
            if (!webappLocation) {
                document.body.replaceChildren(document.createTextNode("ERROR: webapp location not set"))
            }
            const go = new Go();


            // const exit = go.exit
            let exitCode;
            go.exit = function (code) {
                exitCode = code
                // exit(code)
            }
            // const writeSync = globalThis.fs.writeSync
            globalThis.fs.writeSync = function (fd, buf) {
                window.parent.postMessage({name: "writeSync", fd, buf, runID}, webappLocation)
                // return writeSync(fd, buf)
                return buf.length
            }

            const process = await WebAssembly.instantiate(binary, go.importObject)

            const now = Date.now()
            await go.run(process.instance)

            const duration = Date.now() - now
            window.parent.postMessage({name: "exit", exitCode, duration, runID}, webappLocation)
        }

        function main() {
            if (!window.parent) {
                return
            }

            const runID = parseInt(document.querySelector('meta[name="go-playground-run-id"]').getAttribute('content'))

            window.addEventListener("message", event => {
                if (event.origin !== webappLocation)  {
                    return
                }

                if (event.data.name === "binary") {
                    run(runID, event.data['binary'])
                }
            }, false)
        }
        main()
    </script>
</head>