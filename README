#!/usr/bin/env bash

# Playground

####
#### Hello! I am building a Go playground mostly using Go with few external tools.
#### Both the front and back end are written in Go and the user code will be run in the client browser.
####

## Setup Dependencies
function init() {
    go mod download
    local assetsDir="cmd/webapp/assets/"
    mkdir -p "${assetsDir}"
    cp "$(go env GOROOT)/misc/wasm/wasm_exec.js" "${assetsDir}"
}

## Build Webapp Assets
function build_webapp() {
  local webappPackage="cmd/webapp"
  local serverPackage="cmd/server"
  rm -rf "${serverPackage}/webapp"
  cp -rf "${webappPackage}" "${serverPackage}"

  GOOS=js GOARCH=wasm go build -ldflags="-s -w" -o "${serverPackage}/webapp/assets/main.wasm" "./${webappPackage}/"
}

## Run
function run() {
  build_webapp
  go run ./cmd/server
}

function deploy() {
  build_webapp
  ko apply --filename cmd/server/deployment.yml
}

## Any of the functions in this file can be invoked like:
### ./README run
if [ $# -ne 0 ]; then
    "$1"
fi